name: Stabilization CI

on:
  pull_request:
    branches:
      - 'main'
      - 'feature/stabilize/**'
  push:
    branches:
      - 'main'
      - 'feature/stabilize/**'

jobs:
  # Phase 1: IPC Smoke Test
  phase1-ipc-smoke:
    name: "Phase 1: IPC Smoke Test"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
          - os: windows-latest
          - os: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
      
      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libjavascriptcoregtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf libsoup-2.4-dev
      
      - name: Install npm dependencies
        run: npm install
      
      - name: Build backend
        run: cd src-tauri && cargo build
      
      - name: Run IPC smoke test
        run: node scripts/ipc_smoke_test.js
        timeout-minutes: 5
      
      - name: Upload IPC smoke test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ipc-smoke-output-${{ matrix.os }}
          path: stabilization/ipc_smoke_output.txt
          if-no-files-found: warn

  # Phase 2: Cleanup and Build
  phase2-cleanup:
    name: "Phase 2: Cleanup and Build"
    runs-on: ubuntu-22.04
    needs: phase1-ipc-smoke
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libjavascriptcoregtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf libsoup-2.4-dev
      
      - name: Install npm dependencies
        run: npm install
      
      - name: Lint frontend
        run: npm run lint
      
      - name: Type check
        run: npm run type-check
      
      - name: Build frontend
        run: npm run build
      
      - name: Build backend
        run: cd src-tauri && cargo build 2>&1 | tee ../stabilization/audit_warnings.txt
      
      - name: Run backend tests
        run: cd src-tauri && cargo test
      
      - name: Run clippy (allow warnings pre-Phase 5)
        run: cd src-tauri && cargo clippy --all-targets --all-features -- -A warnings 2>&1 | tee ../stabilization/audit_clippy.txt
        if: "!contains(github.ref, 'phase5')"
      
      - name: Run clippy (deny warnings Phase 5+)
        run: cd src-tauri && cargo clippy --all-targets --all-features -- -D warnings 2>&1 | tee ../stabilization/audit_clippy.txt
        if: contains(github.ref, 'phase5')
      
      - name: Generate audit report
        run: bash scripts/generate_audit_report.sh
        continue-on-error: true
      
      - name: Upload audit artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-reports
          path: |
            stabilization/audit_warnings.txt
            stabilization/audit_clippy.txt
            stabilization/audit_report.json
          if-no-files-found: warn

  # Phase 3: Coverage and Security
  phase3-coverage:
    name: "Phase 3: Coverage and Security"
    runs-on: ubuntu-22.04
    needs: phase2-cleanup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libjavascriptcoregtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf libsoup-2.4-dev
      
      - name: Install npm dependencies
        run: npm install
      
      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin
      
      - name: Run coverage measurement
        run: cd src-tauri && cargo tarpaulin --out Xml --out Html --output-dir ../stabilization
        continue-on-error: true
      
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            stabilization/cobertura.xml
            stabilization/tarpaulin-report.html
          if-no-files-found: warn
      
      - name: Run security audit
        run: cd src-tauri && cargo audit
        continue-on-error: true
      
      - name: Run frontend tests
        run: npm run test

  # Phase 4: Reproducible Claim Test
  phase4-reproducible-claim:
    name: "Phase 4: Reproducible Claim Test"
    runs-on: ubuntu-22.04
    needs: phase3-coverage
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libjavascriptcoregtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf libsoup-2.4-dev
      
      - name: Install npm dependencies
        run: npm install
      
      - name: Build backend
        run: cd src-tauri && cargo build
      
      - name: Check test fixtures exist
        run: |
          if [ -f "tests/fixtures/claim_working.json" ]; then
            echo "✓ Test claim fixture found"
          else
            echo "⚠ Test claim fixture not found (expected in Phase 4+)"
          fi
      
      - name: Run reproducible claim test
        run: |
          if [ -f "tests/fixtures/claim_working.json" ]; then
            echo "Running reproducible claim test..."
            # Add actual test command here when implemented
            echo "✓ Reproducible claim test placeholder"
          else
            echo "⚠ Skipping - test fixture not yet created"
          fi

  # Phase 5: Zero Warnings Enforcement
  phase5-zero-warnings:
    name: "Phase 5: Zero Warnings Enforcement"
    runs-on: ubuntu-22.04
    needs: phase4-reproducible-claim
    if: contains(github.ref, 'phase5')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libjavascriptcoregtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf libsoup-2.4-dev
      
      - name: Install npm dependencies
        run: npm install
      
      - name: Build with zero warnings enforcement
        run: cd src-tauri && cargo build 2>&1 | tee build_output.txt && ! grep -i "warning" build_output.txt
      
      - name: Clippy with zero warnings enforcement
        run: cd src-tauri && cargo clippy --all-targets --all-features -- -D warnings
      
      - name: Verify zero warnings
        run: |
          echo "✓ Zero warnings enforcement passed"
          echo "Build and clippy completed with no warnings"
